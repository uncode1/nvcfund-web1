{% extends 'layout.html' %}

{% block title %}NVC Global Payment Form - NVC Banking Platform{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">NVC Global Payment Form</h2>
    
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Transaction Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Amount:</strong> ${{ amount }}</p>
                    <p><strong>Transaction ID:</strong> {{ transaction_id }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Date:</strong> {{ date }}</p>
                    <p><strong>Description:</strong> {{ description }}</p>
                </div>
            </div>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i> <strong>Auto-Save Feature:</strong> Your form information is automatically saved as you complete it. If you encounter any errors or need to come back later, your data will be restored when you return.
    </div>

    <!-- Tabbed navigation for form sections -->
    <ul class="nav nav-tabs mb-3" id="formTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="recipient-tab" data-bs-toggle="tab" data-bs-target="#recipient" type="button" role="tab" aria-controls="recipient" aria-selected="true">
                <i class="fas fa-user me-2"></i>Recipient
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="bank-tab" data-bs-toggle="tab" data-bs-target="#bank" type="button" role="tab" aria-controls="bank" aria-selected="false">
                <i class="fas fa-university me-2"></i>Bank Details
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="international-tab" data-bs-toggle="tab" data-bs-target="#international" type="button" role="tab" aria-controls="international" aria-selected="false">
                <i class="fas fa-globe me-2"></i>International
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settlement-tab" data-bs-toggle="tab" data-bs-target="#settlement" type="button" role="tab" aria-controls="settlement" aria-selected="false">
                <i class="fas fa-money-check-alt me-2"></i>Settlement
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="compliance-tab" data-bs-toggle="tab" data-bs-target="#compliance" type="button" role="tab" aria-controls="compliance" aria-selected="false">
                <i class="fas fa-shield-alt me-2"></i>Compliance
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reference-tab" data-bs-toggle="tab" data-bs-target="#reference" type="button" role="tab" aria-controls="reference" aria-selected="false">
                <i class="fas fa-tag me-2"></i>Reference
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab" aria-controls="review" aria-selected="false">
                <i class="fas fa-check-circle me-2"></i>Review
            </button>
        </li>
    </ul>
    
    <form method="POST" action="{{ url_for('web.main.process_bank_transfer') }}" id="globalPaymentForm">
        {{ form.hidden_tag() }}
        {{ form.transaction_id(value=transaction_id) }}
        {{ form.amount(value=amount) }}
        
        <div class="tab-content" id="formTabContent">
            <!-- Recipient Information Tab -->
            <div class="tab-pane fade show active" id="recipient" role="tabpanel" aria-labelledby="recipient-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Recipient Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_name.label(class="form-label") }}*
                                    {{ form.recipient_name(class="form-control", required=True) }}
                                    <small class="form-text text-muted">Exactly as it appears on their bank account</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_institution_type.label(class="form-label") }}*
                                    {{ form.recipient_institution_type(class="form-select", required=True) }}
                                    <small class="form-text text-muted">Type of entity receiving the funds</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_email.label(class="form-label") }}
                                    {{ form.recipient_email(class="form-control") }}
                                    <small class="form-text text-muted">For payment notifications (optional)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_phone.label(class="form-label") }}
                                    {{ form.recipient_phone(class="form-control") }}
                                    <small class="form-text text-muted">International format recommended (e.g., +1 555 123 4567)</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group">
                                    {{ form.recipient_address.label(class="form-label") }}*
                                    {{ form.recipient_address(class="form-control", required=True) }}
                                    <small class="form-text text-muted">Registered address of the account holder</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.recipient_city.label(class="form-label") }}*
                                    {{ form.recipient_city(class="form-control", required=True) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.recipient_state.label(class="form-label") }}
                                    {{ form.recipient_state(class="form-control") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.recipient_zip.label(class="form-label") }}*
                                    {{ form.recipient_zip(class="form-control", required=True) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_country.label(class="form-label") }}*
                                    {{ form.recipient_country(class="form-control", required=True) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_tax_id.label(class="form-label") }}
                                    {{ form.recipient_tax_id(class="form-control") }}
                                    <small class="form-text text-muted">Tax ID, VAT number, or business registration number if applicable</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.recipient_relationship.label(class="form-label") }}
                                    {{ form.recipient_relationship(class="form-select") }}
                                    <small class="form-text text-muted">Your relationship to the recipient</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-primary" onclick="switchToTab('bank-tab')">Next: Bank Details <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bank Account Information Tab -->
            <div class="tab-pane fade" id="bank" role="tabpanel" aria-labelledby="bank-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Bank Account Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.transfer_type.label(class="form-label") }}*
                                    {{ form.transfer_type(class="form-select", required=True, **{'onchange': 'toggleTransferFields()'}) }}
                                    <small class="form-text text-muted">Select the type of transfer you're making</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.bank_name.label(class="form-label") }}*
                                    {{ form.bank_name(class="form-control", required=True) }}
                                    <small class="form-text text-muted">Full legal name of the receiving bank</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.bank_branch_name.label(class="form-label") }}
                                    {{ form.bank_branch_name(class="form-control") }}
                                    <small class="form-text text-muted">Specific branch name if applicable</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.bank_branch_code.label(class="form-label") }}
                                    {{ form.bank_branch_code(class="form-control") }}
                                    <small class="form-text text-muted">Branch code, sort code, or transit number if applicable</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.account_holder.label(class="form-label") }}*
                                    {{ form.account_holder(class="form-control", required=True) }}
                                    <small class="form-text text-muted">Exact name on the bank account</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.account_number.label(class="form-label") }}*
                                    {{ form.account_number(class="form-control", required=True) }}
                                    <small class="form-text text-muted">Bank account number (no spaces or special characters)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.account_type.label(class="form-label") }}*
                                    {{ form.account_type(class="form-select", required=True) }}
                                </div>
                            </div>
                            
                            <!-- Domestic Transfer Fields -->
                            <div class="col-md-6 domestic-field">
                                <div class="form-group">
                                    {{ form.routing_number.label(class="form-label") }}*
                                    {{ form.routing_number(class="form-control") }}
                                    <small class="form-text text-muted">ABA/Routing number for domestic US transfers</small>
                                </div>
                            </div>
                            
                            <!-- International Transfer Fields -->
                            <div class="col-md-6 international-field" style="display: none;">
                                <div class="form-group">
                                    {{ form.swift_bic.label(class="form-label") }}*
                                    {{ form.swift_bic(class="form-control") }}
                                    <small class="form-text text-muted">8 or 11 character SWIFT/BIC code</small>
                                </div>
                            </div>
                            <div class="col-md-6 international-field" style="display: none;">
                                <div class="form-group">
                                    {{ form.iban.label(class="form-label") }}
                                    {{ form.iban(class="form-control") }}
                                    <small class="form-text text-muted">International Bank Account Number</small>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-group">
                                    {{ form.bank_address.label(class="form-label") }}*
                                    {{ form.bank_address(class="form-control", required=True) }}
                                    <small class="form-text text-muted">Full address of the bank branch</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.bank_city.label(class="form-label") }}*
                                    {{ form.bank_city(class="form-control", required=True) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.bank_state.label(class="form-label") }}
                                    {{ form.bank_state(class="form-control") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.bank_country.label(class="form-label") }}*
                                    {{ form.bank_country(class="form-control", required=True) }}
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="switchToTab('recipient-tab')"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                            <button type="button" class="btn btn-primary" onclick="switchToTab('international-tab')">Next: International <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- International Transfer Details Tab -->
            <div class="tab-pane fade" id="international" role="tabpanel" aria-labelledby="international-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">International Transfer Details</h5>
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i> These details are required for international transfers only. If you're making a domestic transfer, you can skip to the next section.
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.currency.label(class="form-label") }}*
                                    {{ form.currency(class="form-select") }}
                                    <small class="form-text text-muted">Currency for the transfer</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.purpose.label(class="form-label") }}*
                                    {{ form.purpose(class="form-select") }}
                                    <small class="form-text text-muted">Required for regulatory compliance</small>
                                </div>
                            </div>
                            <div class="col-12" id="purpose_detail_group" style="display: none;">
                                <div class="form-group">
                                    {{ form.purpose_detail.label(class="form-label") }}
                                    {{ form.purpose_detail(class="form-control") }}
                                    <small class="form-text text-muted">Please provide specific details about the purpose of this payment</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.intermediary_bank.label(class="form-label") }}
                                    {{ form.intermediary_bank(class="form-control") }}
                                    <small class="form-text text-muted">If the receiving bank requires an intermediary</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.intermediary_swift.label(class="form-label") }}
                                    {{ form.intermediary_swift(class="form-control") }}
                                    <small class="form-text text-muted">SWIFT/BIC code of the intermediary bank</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="switchToTab('bank-tab')"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                            <button type="button" class="btn btn-primary" onclick="switchToTab('settlement-tab')">Next: Settlement <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settlement Information Tab -->
            <div class="tab-pane fade" id="settlement" role="tabpanel" aria-labelledby="settlement-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Settlement Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.settlement_method.label(class="form-label") }}
                                    {{ form.settlement_method(class="form-select") }}
                                    <small class="form-text text-muted">Select your preferred settlement method</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.charge_bearer.label(class="form-label") }}
                                    {{ form.charge_bearer(class="form-select") }}
                                    <small class="form-text text-muted">Who will pay the transfer fees</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <h6>Fees and Processing Time:</h6>
                            <ul class="mb-0">
                                <li><strong>Standard:</strong> 3-5 business days, 1% fee (minimum $5)</li>
                                <li><strong>Express:</strong> 1-2 business days, 2% fee (minimum $10)</li>
                                <li><strong>Same Day:</strong> Same business day (where available), 3% fee (minimum $20)</li>
                                <li><strong>Wire Transfer:</strong> 1-2 business days, $25 flat fee</li>
                                <li><strong>ACH Transfer:</strong> 3-5 business days, $3 flat fee (US only)</li>
                                <li><strong>RTGS:</strong> Same business day (where available), fees vary by country</li>
                                <li>International transfers may incur additional correspondent bank fees.</li>
                                <li>Currency conversion includes a 1% foreign exchange spread.</li>
                            </ul>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="switchToTab('international-tab')"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                            <button type="button" class="btn btn-primary" onclick="switchToTab('compliance-tab')">Next: Compliance <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Compliance Information Tab -->
            <div class="tab-pane fade" id="compliance" role="tabpanel" aria-labelledby="compliance-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Compliance Information</h5>
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i> This information is required for regulatory compliance and anti-money laundering purposes.
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.source_of_funds.label(class="form-label") }}
                                    {{ form.source_of_funds(class="form-select") }}
                                    <small class="form-text text-muted">Source of the funds being transferred</small>
                                </div>
                            </div>
                            <div class="col-md-6" id="source_funds_detail_group">
                                <div class="form-group">
                                    {{ form.source_of_funds_detail.label(class="form-label") }}
                                    {{ form.source_of_funds_detail(class="form-control") }}
                                    <small class="form-text text-muted">Please provide additional details if necessary</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="form-check mb-3">
                                {{ form.compliance_agree(class="form-check-input") }}
                                {{ form.compliance_agree.label(class="form-check-label fw-bold") }}
                                <div class="form-text">
                                    I confirm that this transaction complies with all applicable laws, regulations, and is not related to any illegal activities.
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="switchToTab('settlement-tab')"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                            <button type="button" class="btn btn-primary" onclick="switchToTab('reference-tab')">Next: Reference <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reference Information Tab -->
            <div class="tab-pane fade" id="reference" role="tabpanel" aria-labelledby="reference-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Reference Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.reference.label(class="form-label") }}
                                    {{ form.reference(class="form-control") }}
                                    <small class="form-text text-muted">Payment reference (seen by recipient)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.invoice_number.label(class="form-label") }}
                                    {{ form.invoice_number(class="form-control") }}
                                    <small class="form-text text-muted">Invoice number if applicable</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group">
                                    {{ form.description.label(class="form-label") }}
                                    {{ form.description(class="form-control", value=description if description else '') }}
                                    <small class="form-text text-muted">Will appear on recipient's statement</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.notes_to_recipient.label(class="form-label") }}
                                    {{ form.notes_to_recipient(class="form-control") }}
                                    <small class="form-text text-muted">Additional message to the recipient</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.notes_to_bank.label(class="form-label") }}
                                    {{ form.notes_to_bank(class="form-control") }}
                                    <small class="form-text text-muted">Special instructions for the bank</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="switchToTab('compliance-tab')"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                            <button type="button" class="btn btn-primary" onclick="switchToTab('review-tab')">Next: Review <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Review and Submit Tab -->
            <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Review and Submit</h5>
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i> Please review all the information carefully before submitting. Once submitted, the transaction will be processed according to your selected settlement method.
                        </div>
                        
                        <div id="summary-content">
                            <!-- This will be populated by JavaScript -->
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading transaction summary...</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="form-check mb-3">
                                {{ form.terms_agree(class="form-check-input") }}
                                {{ form.terms_agree.label(class="form-check-label fw-bold") }}
                                <div class="form-text">
                                    I confirm that all the information provided is accurate and complete. I authorize NVC Banking Platform to process this transfer according to the provided instructions.
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="switchToTab('reference-tab')"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                            <button type="submit" class="btn btn-success"><i class="fas fa-check-circle me-2"></i>Process Global Payment</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function toggleTransferFields() {
    const transferType = document.getElementById('transfer_type').value;
    const domesticFields = document.querySelectorAll('.domestic-field');
    const internationalFields = document.querySelectorAll('.international-field');
    
    if (transferType === 'domestic') {
        domesticFields.forEach(field => field.style.display = 'block');
        internationalFields.forEach(field => field.style.display = 'none');
        document.getElementById('routing_number').setAttribute('required', 'required');
        document.getElementById('swift_bic').removeAttribute('required');
        document.getElementById('currency').removeAttribute('required');
        document.getElementById('purpose').removeAttribute('required');
    } else if (transferType === 'international') {
        domesticFields.forEach(field => field.style.display = 'none');
        internationalFields.forEach(field => field.style.display = 'block');
        document.getElementById('routing_number').removeAttribute('required');
        document.getElementById('swift_bic').setAttribute('required', 'required');
        document.getElementById('currency').setAttribute('required', 'required');
        document.getElementById('purpose').setAttribute('required', 'required');
    }
}

function switchToTab(tabId) {
    // First validate the current tab if moving forward
    const currentActiveTab = document.querySelector('.tab-pane.active');
    const targetTab = document.getElementById(tabId);
    
    // Find the index of the tabs to determine if we're moving forward or backward
    const tabs = Array.from(document.querySelectorAll('.nav-link'));
    const currentIndex = tabs.findIndex(tab => tab.classList.contains('active'));
    const targetIndex = tabs.findIndex(tab => tab.id === tabId);
    
    // Only validate if moving forward
    if (targetIndex > currentIndex && !validateCurrentTab(currentActiveTab.id)) {
        return false;
    }
    
    // Switch to the target tab
    const tabElement = document.getElementById(tabId);
    const tab = new bootstrap.Tab(tabElement);
    tab.show();
    
    // If switching to the review tab, populate the summary
    if (tabId === 'review-tab') {
        populateSummary();
    }
    
    return true;
}

function validateCurrentTab(tabId) {
    // Get all required fields in the current tab
    const currentTab = document.getElementById(tabId);
    const requiredFields = currentTab.querySelectorAll('[required]');
    
    // Check if all required fields are filled
    let isValid = true;
    requiredFields.forEach(field => {
        if (!field.value) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        // Show validation message
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i> Please fill in all required fields marked with an asterisk (*).
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Check if the alert already exists
        if (!currentTab.querySelector('.alert-danger')) {
            currentTab.querySelector('.card-body').insertAdjacentHTML('afterbegin', alertHtml);
        }
    }
    
    return isValid;
}

function populateSummary() {
    const form = document.getElementById('globalPaymentForm');
    const summaryElement = document.getElementById('summary-content');
    
    // Get form data
    const formData = new FormData(form);
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (key !== 'csrf_token') {
            data[key] = value;
        }
    }
    
    // Build HTML for summary
    let html = `
        <div class="summary-section mb-4">
            <h5><i class="fas fa-money-bill-wave me-2"></i>Transaction Details</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Amount:</strong> $${data.amount}</p>
                    <p><strong>Transaction ID:</strong> ${data.transaction_id}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Transfer Type:</strong> ${data.transfer_type === 'domestic' ? 'Domestic' : 'International'}</p>
                    <p><strong>Settlement Method:</strong> ${document.getElementById('settlement_method').options[document.getElementById('settlement_method').selectedIndex].text}</p>
                </div>
            </div>
        </div>
        
        <div class="summary-section mb-4">
            <h5><i class="fas fa-user me-2"></i>Recipient Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> ${data.recipient_name}</p>
                    <p><strong>Type:</strong> ${document.getElementById('recipient_institution_type').options[document.getElementById('recipient_institution_type').selectedIndex].text}</p>
                    <p><strong>Email:</strong> ${data.recipient_email || 'Not provided'}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Address:</strong> ${data.recipient_address}</p>
                    <p><strong>City/State/Zip:</strong> ${data.recipient_city}, ${data.recipient_state || ''} ${data.recipient_zip}</p>
                    <p><strong>Country:</strong> ${data.recipient_country}</p>
                </div>
            </div>
        </div>
        
        <div class="summary-section mb-4">
            <h5><i class="fas fa-university me-2"></i>Bank Details</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Bank Name:</strong> ${data.bank_name}</p>
                    <p><strong>Account Holder:</strong> ${data.account_holder}</p>
                    <p><strong>Account Number:</strong> ${data.account_number}</p>
                    <p><strong>Account Type:</strong> ${document.getElementById('account_type').options[document.getElementById('account_type').selectedIndex].text}</p>
                </div>
                <div class="col-md-6">
    `;
    
    if (data.transfer_type === 'domestic') {
        html += `<p><strong>Routing Number:</strong> ${data.routing_number}</p>`;
    } else {
        html += `
            <p><strong>SWIFT/BIC Code:</strong> ${data.swift_bic}</p>
            <p><strong>IBAN:</strong> ${data.iban || 'Not provided'}</p>
            <p><strong>Currency:</strong> ${document.getElementById('currency').options[document.getElementById('currency').selectedIndex].text}</p>
        `;
    }
    
    html += `
                    <p><strong>Bank Address:</strong> ${data.bank_address}, ${data.bank_city}, ${data.bank_country}</p>
                </div>
            </div>
        </div>
        
        <div class="summary-section">
            <h5><i class="fas fa-tag me-2"></i>Reference Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Reference:</strong> ${data.reference || 'Not provided'}</p>
                    <p><strong>Invoice Number:</strong> ${data.invoice_number || 'Not provided'}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Description:</strong> ${data.description || 'Not provided'}</p>
                    <p><strong>Purpose:</strong> ${data.purpose ? document.getElementById('purpose').options[document.getElementById('purpose').selectedIndex].text : 'Not applicable'}</p>
                </div>
            </div>
        </div>
    `;
    
    summaryElement.innerHTML = html;
}

// Wait for the DOM to be fully loaded before attaching event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Set up transfer type change handler
    const transferTypeSelect = document.getElementById('transfer_type');
    if (transferTypeSelect) {
        transferTypeSelect.addEventListener('change', toggleTransferFields);
        
        // Initialize the form based on the current selection
        toggleTransferFields();
    }
    
    // Set up purpose change handler
    const purposeSelect = document.getElementById('purpose');
    if (purposeSelect) {
        purposeSelect.addEventListener('change', function() {
            const purposeGroup = document.getElementById('purpose_detail_group');
            if (this.value === 'other') {
                purposeGroup.style.display = 'block';
                document.getElementById('purpose_detail').setAttribute('required', 'required');
            } else {
                purposeGroup.style.display = 'none';
                document.getElementById('purpose_detail').removeAttribute('required');
            }
        });
        
        // Initialize the purpose detail field based on current selection
        if (purposeSelect.value === 'other') {
            document.getElementById('purpose_detail_group').style.display = 'block';
            document.getElementById('purpose_detail').setAttribute('required', 'required');
        }
    }
    
    // Set up source of funds change handler
    const sourceOfFundsSelect = document.getElementById('source_of_funds');
    if (sourceOfFundsSelect) {
        sourceOfFundsSelect.addEventListener('change', function() {
            const detailGroup = document.getElementById('source_funds_detail_group');
            if (this.value === 'other') {
                document.getElementById('source_of_funds_detail').setAttribute('required', 'required');
            } else {
                document.getElementById('source_of_funds_detail').removeAttribute('required');
            }
        });
    }
    
    // Set up auto-save feature using localStorage
    const form = document.querySelector('form');
    const formInputs = form.querySelectorAll('input, select, textarea');
    const localStorageKey = 'nvc_global_payment_form_' + document.getElementById('transaction_id').value;
    
    // Load saved form data from localStorage if available
    const savedData = localStorage.getItem(localStorageKey);
    if (savedData) {
        const savedFormData = JSON.parse(savedData);
        formInputs.forEach(input => {
            if (input.name && input.name !== 'csrf_token' && savedFormData[input.name]) {
                if (input.type === 'checkbox') {
                    input.checked = savedFormData[input.name] === 'true';
                } else {
                    input.value = savedFormData[input.name];
                }
            }
        });
        
        // Make sure to update any dependent fields
        if (document.getElementById('transfer_type')) {
            toggleTransferFields();
        }
        
        if (document.getElementById('purpose')) {
            const purposeGroup = document.getElementById('purpose_detail_group');
            if (document.getElementById('purpose').value === 'other') {
                purposeGroup.style.display = 'block';
                document.getElementById('purpose_detail').setAttribute('required', 'required');
            }
        }
    }
    
    // Save form data to localStorage when inputs change
    formInputs.forEach(input => {
        if (input.name && input.name !== 'csrf_token') {
            input.addEventListener('change', saveFormState);
            input.addEventListener('keyup', saveFormState);
        }
    });
    
    function saveFormState() {
        const formData = {};
        formInputs.forEach(input => {
            if (input.name && input.name !== 'csrf_token') {
                if (input.type === 'checkbox') {
                    formData[input.name] = input.checked.toString();
                } else {
                    formData[input.name] = input.value;
                }
            }
        });
        localStorage.setItem(localStorageKey, JSON.stringify(formData));
    }
    
    // Clear localStorage data when form is submitted
    form.addEventListener('submit', function() {
        localStorage.removeItem(localStorageKey);
    });
});
</script>
{% endblock %}